{{- $postgresConfig := .Values.postgresql -}}
{{- if not $postgresConfig }}
{{- $postgresConfig = .Values.postgresql -}}
{{- end }}
{{- $postgresUser := "postgres" -}}
{{- if and $postgresConfig $postgresConfig.env $postgresConfig.env.vars (hasKey $postgresConfig.env.vars "POSTGRES_USER") }}
{{- $postgresUser = index $postgresConfig.env.vars "POSTGRES_USER" -}}
{{- end }}
{{- $postgresPort := 5432 -}}
{{- if and $postgresConfig $postgresConfig.service $postgresConfig.service.port }}
{{- $postgresPort = $postgresConfig.service.port -}}
{{- end }}
{{- $postgresHost := include "crucible.postgresql.serviceName" . -}}
{{- $postgresSecretName := include "crucible.postgresql.secretName" . -}}
{{- $keycloakConfig := .Values.keycloak | default dict -}}
{{- $keycloakExternalDb := $keycloakConfig.externalDatabase | default dict -}}
{{- $keycloakDbName := tpl ($keycloakExternalDb.database | default "keycloak") . -}}
{{- $keycloakDbUser := tpl ($keycloakExternalDb.user | default "postgres") . -}}
{{- $keycloakDbHost := tpl ($keycloakExternalDb.host | default (include "crucible.postgresql.serviceName" .)) . -}}
{{- $keycloakDbSecretName := tpl ($keycloakExternalDb.existingSecret | default $postgresSecretName) . -}}
{{- $keycloakDbSecretKey := $keycloakExternalDb.existingSecretPasswordKey | default "postgres-password" -}}
{{- if $keycloakConfig.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-postgres-create-keycloak-db"
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/instance: "{{ .Release.Name }}"
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    "helm.sh/hook-weight": "-5"
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: create-keycloak-db
        image: postgres:15-alpine
        env:
        - name: KEYCLOAK_PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ $keycloakDbSecretName }}
              key: {{ $keycloakDbSecretKey }}
        command:
        - sh
        - -c
        - |
          # Wait for Keycloak database host to be ready
          until pg_isready -h {{ $keycloakDbHost }} -p {{ $postgresPort }} -U "{{ $keycloakDbUser }}" ; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 5
          done
          echo "PostgreSQL is ready - checking Keycloak database"

          # Check if Keycloak database exists
          DB_EXISTS=$(PGPASSWORD="${KEYCLOAK_PGPASSWORD}" psql -h {{ $keycloakDbHost }} -p {{ $postgresPort }} -U "{{ $keycloakDbUser }}" -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='{{ $keycloakDbName }}'")

          if [ "$DB_EXISTS" = "1" ]; then
            echo "Database '{{ $keycloakDbName }}' already exists, skipping creation"
          else
            echo "Creating database '{{ $keycloakDbName }}'"
            PGPASSWORD="${KEYCLOAK_PGPASSWORD}" psql -h {{ $keycloakDbHost }} -p {{ $postgresPort }} -U "{{ $keycloakDbUser }}" -d postgres \
              -c "CREATE DATABASE {{ $keycloakDbName }};"
            echo "Database '{{ $keycloakDbName }}' created successfully"
          fi
      # optionally add serviceAccountName, imagePullSecrets, etc.
{{- end }}
